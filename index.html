<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OnlineChat</title>
  <style>
    /* 全体設定 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background-color: #7b8f94; /* LINE風の背景色 */
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #000;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ヘッダー */
    #chat-header {
      background-color: #3d414d;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      z-index: 10;
    }
    #chat-header h1 {
      margin: 0;
      font-size: 1em;
      font-weight: bold;
    }

    /* メッセージ表示エリア */
    #messages {
      flex: 1;
      padding: 20px 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px; /* メッセージ間の余白 */
    }

    /* メッセージコンテナの共通スタイル */
    .message-container {
      display: flex;
      flex-direction: column;
      max-width: 70%;
    }
    .sender-name {
      font-size: 12px;
      color: #333;
      margin-left: 5px;
      margin-bottom: 4px;
    }
    .message-bubble {
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word; /* 長い単語を折り返す */
      white-space: pre-wrap; /* 改行を反映 */
    }

    /* 他人のメッセージ (左側) */
    .other-message {
      align-self: flex-start;
      align-items: flex-start;
    }
    .other-message .message-bubble {
      background-color: #ffffff;
      border-top-left-radius: 4px;
    }

    /* 自分のメッセージ (右側) */
    .my-message {
      align-self: flex-end;
      align-items: flex-end;
    }
    .my-message .sender-name {
      display: none; /* 自分の名前は表示しない */
    }
    .my-message .message-bubble {
      background-color: #8de041; /* LINE風の緑色 */
      border-top-right-radius: 4px;
    }

    /* システムメッセージ (中央) */
    .system-message {
      align-self: center;
      background-color: rgba(0, 0, 0, 0.2);
      color: white;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 10px;
      text-align: center;
    }

    /* チャットコントロール（入力欄と送信ボタンのコンテナ） */
    #chat-controls {
      display: flex;
      padding: 8px;
      background-color: #f0f0f0;
      border-top: 1px solid #ddd;
      align-items: center;
    }
    /* 入力欄 */
    #input {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 20px;
      background-color: #fff;
      color: #000;
    }
    #input:focus {
      outline: none;
      border-color: #007bff;
    }

    /* 送信ボタン */
    #send {
      margin-left: 8px;
      padding: 10px 16px;
      background-color: #007bff;
      border: none;
      border-radius: 20px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #send:hover {
      background-color: #0056b3;
    }

    /* 元のユーザーリストは非表示に */
    #userlist {
      display: none;
    }
  </style>
</head>
<body>
  <header id="chat-header">
    <h1>OnlineChat</h1>
  </header>
  <div id="messages"></div>
  <div id="chat-controls">
    <input id="input" placeholder="メッセージを入力" list="sug">
    <button id="send">送信</button>
  </div>
  <datalist id="sug"></datalist>
  <div id="userlist"></div>

<script>
  let isAdmin = false;
  let username = '';
  const socket = new WebSocket("wss://superchat.maikanamaikana.workers.dev/ws");
  let lastMessage = "";

  /**
   * メッセージを画面に表示する関数
   * @param {string} name - 送信者名 (システムメッセージの場合はnull)
   * @param {string} text - メッセージ本文
   * @param {object} options - オプション
   * @param {boolean} options.isMine - 自分のメッセージかどうか
   * @param {string} options.type - 'user' or 'system'
   */
  function appendMessage(name, text, options = {}) {
    const { isMine = false, type = 'user' } = options;
    const messagesDiv = document.getElementById("messages");

    if (type === 'system') {
      const p = document.createElement("div");
      p.className = 'system-message';
      p.textContent = text;
      messagesDiv.appendChild(p);
    } else { // ユーザーメッセージ
      const container = document.createElement("div");
      container.className = 'message-container ' + (isMine ? 'my-message' : 'other-message');

      // 他人のメッセージの場合のみ名前を表示
      if (!isMine) {
        const nameSpan = document.createElement("span");
        nameSpan.className = 'sender-name';
        nameSpan.textContent = name;
        container.appendChild(nameSpan);
      }

      const bubble = document.createElement("div");
      bubble.className = 'message-bubble';
      bubble.textContent = text;
      
      container.appendChild(bubble);
      messagesDiv.appendChild(container);
    }
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function send() {
    const input = document.getElementById("input");
    const msg = input.value.trim();
    if (!msg) return;
    if (msg === lastMessage) return;
    lastMessage = msg;

    // コマンド処理（管理者）
    if (msg.startsWith('@kick ') && isAdmin) {
      const target = msg.match(/@kick\s+"(.+?)"/)?.[1];
      if (target) {
        if (confirm(`本当に ${target} をキックしますか？`)) {
          socket.send(JSON.stringify({ type: "system", action: "kick", target }));
          appendMessage(null, `${target} をキックしました`, { type: 'system' });
        } else {
          appendMessage(null, `${target} のキックをキャンセルしました`, { type: 'system' });
        }
      } else {
        alert("キックするユーザー名を指定してください\n例: @kick \"ユーザー名\"");
      }
    } else if (msg.startsWith('@tell ') && isAdmin) {
      const match = msg.match(/@tell\s+"(.+?)"\s+(.+)/);
      if (match) {
        const to = match[1];
        const privateMsg = match[2];
        socket.send(JSON.stringify({ type: "private", from: username, to, msg: privateMsg }));
        appendMessage(username, `[${to} へのDM] ${privateMsg}`, { isMine: true });
      } else {
        alert("プライベートメッセージの形式が正しくありません\n例: @tell \"ユーザー名\" メッセージ");
      }
    } else {
      socket.send(JSON.stringify({ type: "msg", name: username, msg }));
      // 自分のメッセージを送信時に画面に表示
      appendMessage(username, msg, { isMine: true });
    }
    input.value = "";
  }

  function promptName() {
    let name = prompt("名前を入力（アルファベットのみ）");
    while (!name || !/^[A-Za-z]+$/.test(name)) {
      name = prompt("名前はアルファベットのみで入力してください");
    }
    return name;
  }

  username = promptName();

  socket.addEventListener("open", () => {
    appendMessage(null, "接続されました", { type: 'system' });
  });

  socket.addEventListener("message", (event) => {
    const data = JSON.parse(event.data);

    // 自分のメッセージは送信時に表示済みなので、サーバーからのブロードキャストは無視する
    if (data.name === username) return;

    if (data.type === "system") {
      if (data.msg === "キックされました") {
        alert("キックされました");
        document.body.innerHTML = "<h1 style='color:white;text-align:center;'>キックされました</h1>";
        return;
      }
      appendMessage(null, `[System] ${data.msg}`, { type: 'system' });
    } else if (data.type === "private" && data.to === username) {
      appendMessage(null, `[${data.from}からのDM] ${data.msg}`, { type: 'system' });
    } else if (data.name && data.msg) {
      appendMessage(data.name, data.msg, { isMine: false });
    }
  });

  document.getElementById("send").onclick = send;
  document.getElementById("input").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.isComposing) {
        e.preventDefault(); // Enterでの改行を防ぐ
        send();
    }
    if (e.key === "@") {
      if (!isAdmin) {
        const pass = prompt("管理者パスワードを入力してください");
        if (pass === "Death") {
          isAdmin = true;
          alert("管理者モードになりました");
        } else {
          alert("パスワードが違います");
        }
      } else {
        document.getElementById("sug").innerHTML = `
          <option value='@kick "username"'></option>
          <option value='@tell "username" メッセージ'></option>
        `;
      }
    }
  });
</script>
</body>
</html>
