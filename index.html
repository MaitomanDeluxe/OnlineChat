<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Workers Chat</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #messages { flex-grow: 1; overflow-y: scroll; padding: 10px; border: 1px solid #ccc; margin: 10px; }
        #input-container { display: flex; padding: 10px; }
        #message-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #send-button { margin-left: 10px; padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #send-button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div id="messages"></div>
    <div id="input-container">
        <input type="text" id="message-input" placeholder="メッセージを入力...">
        <button id="send-button">送信</button>
    </div>

    <script>
        let socket;
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // Cloudflare WorkersのURLをここに設定します
        const WORKER_URL = 'YOUR_CLOUDFLARE_WORKER_URL'; // 後で更新します

        function connectWebSocket() {
            socket = new WebSocket(WORKER_URL);

            socket.onopen = (event) => {
                console.log('WebSocket接続が開かれました:', event);
                messagesDiv.innerHTML += '<p><em>チャットに接続しました。</em></p>';
            };

            socket.onmessage = (event) => {
                const message = event.data;
                console.log('メッセージを受信しました:', message);
                messagesDiv.innerHTML += `<p>${message}</p>`;
                messagesDiv.scrollTop = messagesDiv.scrollHeight; // スクロールを一番下へ
            };

            socket.onclose = (event) => {
                console.log('WebSocket接続が閉じられました:', event);
                messagesDiv.innerHTML += '<p><em>チャットから切断されました。再接続を試みます...</em></p>';
                setTimeout(connectWebSocket, 3000); // 3秒後に再接続を試みる
            };

            socket.onerror = (error) => {
                console.error('WebSocketエラー:', error);
                messagesDiv.innerHTML += '<p style="color: red;"><em>WebSocketエラーが発生しました。</em></p>';
            };
        }

        sendButton.addEventListener('click', () => {
            const message = messageInput.value;
            if (message.trim() !== '') {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(message);
                    messageInput.value = '';
                } else {
                    console.warn('WebSocketが接続されていません。');
                    messagesDiv.innerHTML += '<p style="color: orange;"><em>メッセージを送信できませんでした。接続を確認してください。</em></p>';
                }
            }
        });

        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendButton.click();
            }
        });

        // WebSocket接続を開始
        connectWebSocket();
    </script>
</body>
</html>
