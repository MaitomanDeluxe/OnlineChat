export default {
  async fetch(req, env, ctx) {
    if (req.headers.get("upgrade") !== "websocket") {
      return new Response("期待されたWebSocket接続ではありません", { status: 400 });
    }

    const [client, server] = Object.values(new WebSocketPair());
    handleSession(server);
    return new Response(null, { status: 101, webSocket: client });
  }
};

let clients = new Map();
let idCounter = 0;

function broadcastPlayers() {
  const players = {};
  for (const [id, ws] of clients) {
    players[id] = ws.state;
  }
  const message = JSON.stringify({ players });
  for (const [, ws] of clients) {
    try {
      ws.socket.send(message);
    } catch (e) {}
  }
}

function handleSession(ws) {
  const id = "player" + (++idCounter);
  const socket = ws.accept();
  const state = { x: 100, y: 100, vy: 0, onGround: true };
  clients.set(id, { socket, state });

  socket.send(JSON.stringify({ id, players: Object.fromEntries([...clients].map(([k, v]) => [k, v.state])) }));

  socket.addEventListener("message", event => {
    try {
      const data = JSON.parse(event.data);
      if (data.type === "ping") return; // pingは無視
      clients.get(id).state = data;
      broadcastPlayers();
    } catch (e) {
      console.log("不正なデータ", e);
    }
  });

  socket.addEventListener("close", () => {
    clients.delete(id);
    broadcastPlayers();
  });

  socket.addEventListener("error", () => {
    clients.delete(id);
    broadcastPlayers();
  });
}
